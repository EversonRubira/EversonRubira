name: Update README with Recent Projects

on:
  schedule:
    # Roda todo dia √†s 00:00 UTC (01:00 em Portugal)
    - cron: '0 0 * * *'
  workflow_dispatch: # Permite executar manualmente
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update README with recent projects
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'EversonRubira';
            
            console.log('üîç Buscando reposit√≥rios...');
            
            // Buscar todos os reposit√≥rios p√∫blicos ordenados por √∫ltimo push
            const { data: repos } = await github.rest.repos.listForUser({
              username: owner,
              sort: 'pushed',
              direction: 'desc',
              per_page: 100
            });
            
            console.log(`üì¶ Total de reposit√≥rios encontrados: ${repos.length}`);
            
            // Filtrar reposit√≥rios pr√≥prios (n√£o forks) e excluir o repo do perfil
            const recentRepos = repos
              .filter(repo => !repo.fork && repo.name !== 'EversonRubira')
              .slice(0, 4);
            
            console.log('‚úÖ Reposit√≥rios selecionados:');
            recentRepos.forEach(repo => console.log(`   - ${repo.name}`));
            
            // Gerar markdown para cada reposit√≥rio
            let content = '';
            
            for (const repo of recentRepos) {
              console.log(`\nüìù Processando: ${repo.name}`);
              
              // Buscar linguagens do reposit√≥rio
              const { data: languages } = await github.rest.repos.listLanguages({
                owner,
                repo: repo.name
              });
              
              // Pegar as 3 principais linguagens
              const topLangs = Object.keys(languages).slice(0, 3);
              const techStack = topLangs.length > 0 ? topLangs.join(', ') : repo.language || 'N/A';
              
              // Formatar data do √∫ltimo push
              const lastPush = new Date(repo.pushed_at).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
              });
              
              // Buscar √∫ltimo commit para ter contexto adicional
              let lastCommitMsg = '';
              try {
                const { data: commits } = await github.rest.repos.listCommits({
                  owner,
                  repo: repo.name,
                  per_page: 1
                });
                
                if (commits.length > 0) {
                  lastCommitMsg = commits[0].commit.message.split('\n')[0]; // Primeira linha
                  // Limitar tamanho da mensagem
                  if (lastCommitMsg.length > 60) {
                    lastCommitMsg = lastCommitMsg.substring(0, 57) + '...';
                  }
                }
              } catch (error) {
                console.log(`   ‚ö†Ô∏è N√£o foi poss√≠vel buscar commits: ${error.message}`);
              }
              
              // Construir o bloco markdown
              content += `### [${repo.name}](${repo.html_url})`;
              
              // Adicionar badge de estrelas se tiver
              if (repo.stargazers_count > 0) {
                content += ` ‚≠ê`;
              }
              
              content += `\n`;
              content += `${repo.description || 'Projeto em desenvolvimento'}\n\n`;
              content += `**Tech:** ${techStack}`;
              
              // Adicionar informa√ß√µes adicionais
              if (repo.stargazers_count > 0 || repo.forks_count > 0) {
                content += ` | **Stars:** ‚≠ê ${repo.stargazers_count}`;
                if (repo.forks_count > 0) {
                  content += ` | **Forks:** üç¥ ${repo.forks_count}`;
                }
              }
              
              content += `  \n**Last update:** ${lastPush}`;
              
              if (lastCommitMsg) {
                content += ` | üí¨ _"${lastCommitMsg}"_`;
              }
              
              content += `\n\n---\n\n`;
            }
            
            console.log('\nüìñ Lendo README atual...');
            
            // Ler README atual
            const { data: readmeData } = await github.rest.repos.getContent({
              owner,
              repo: 'EversonRubira',
              path: 'README.md'
            });
            
            const readme = Buffer.from(readmeData.content, 'base64').toString('utf-8');
            
            // Substituir conte√∫do entre os marcadores
            const startMarker = '<!-- RECENT_PROJECTS:START -->';
            const endMarker = '<!-- RECENT_PROJECTS:END -->';
            
            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`, 'g');
            
            if (!regex.test(readme)) {
              console.error('‚ùå Marcadores n√£o encontrados no README!');
              core.setFailed('Marcadores <!-- RECENT_PROJECTS:START --> e <!-- RECENT_PROJECTS:END --> n√£o encontrados');
              return;
            }
            
            const newReadme = readme.replace(
              regex,
              `${startMarker}\n${content}${endMarker}`
            );
            
            // Verificar se houve mudan√ßas
            if (readme === newReadme) {
              console.log('‚ú® Nenhuma mudan√ßa detectada. README j√° est√° atualizado!');
              return;
            }
            
            console.log('üíæ Atualizando README...');
            
            // Atualizar README
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo: 'EversonRubira',
              path: 'README.md',
              message: 'ü§ñ Auto-update: Recent projects updated',
              content: Buffer.from(newReadme).toString('base64'),
              sha: readmeData.sha
            });
            
            console.log('‚úÖ README atualizado com sucesso!');
