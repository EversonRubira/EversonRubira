name: Update README with Recent Projects

on:
  schedule:
    # Runs daily at 00:00 UTC (01:00 Portugal time)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual execution
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update README with recent projects
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'EversonRubira';
            
            console.log('ğŸ” Fetching repositories...');
            
            // Fetch all public repositories sorted by last push
            const { data: repos } = await github.rest.repos.listForUser({
              username: owner,
              sort: 'pushed',
              direction: 'desc',
              per_page: 100
            });
            
            console.log(`ğŸ“¦ Total repositories found: ${repos.length}`);
            
            // Filter own repositories (not forks) and exclude profile repo
            const recentRepos = repos
              .filter(repo => !repo.fork && repo.name !== 'EversonRubira')
              .slice(0, 4);
            
            console.log('âœ… Selected repositories:');
            recentRepos.forEach(repo => console.log(`   - ${repo.name}`));
            
            // Month names in English
            const monthNames = {
              'jan.': 'Jan',
              'fev.': 'Feb',
              'mar.': 'Mar',
              'abr.': 'Apr',
              'mai.': 'May',
              'jun.': 'Jun',
              'jul.': 'Jul',
              'ago.': 'Aug',
              'set.': 'Sep',
              'out.': 'Oct',
              'nov.': 'Nov',
              'dez.': 'Dec'
            };
            
            // Generate markdown for each repository
            let content = '';
            
            for (const repo of recentRepos) {
              console.log(`\nğŸ“ Processing: ${repo.name}`);
              
              // Fetch repository languages
              const { data: languages } = await github.rest.repos.listLanguages({
                owner,
                repo: repo.name
              });
              
              // Get top 3 languages
              const topLangs = Object.keys(languages).slice(0, 3);
              const techStack = topLangs.length > 0 ? topLangs.join(', ') : repo.language || 'N/A';
              
              // Format last push date in English
              const lastPushDate = new Date(repo.pushed_at);
              let formattedDate = lastPushDate.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              });
              
              // Fetch last commit for additional context
              let lastCommitMsg = '';
              try {
                const { data: commits } = await github.rest.repos.listCommits({
                  owner,
                  repo: repo.name,
                  per_page: 1
                });
                
                if (commits.length > 0) {
                  lastCommitMsg = commits[0].commit.message.split('\n')[0];
                  // Limit message length
                  if (lastCommitMsg.length > 60) {
                    lastCommitMsg = lastCommitMsg.substring(0, 57) + '...';
                  }
                }
              } catch (error) {
                console.log(`   âš ï¸ Could not fetch commits: ${error.message}`);
              }
              
              // Build markdown block
              content += `### ğŸ”¹ [${repo.name}](${repo.html_url})`;
              
              // Add star badge if has stars
              if (repo.stargazers_count > 0) {
                content += ` â­ ${repo.stargazers_count}`;
              }
              
              content += `\n`;
              
              // Description
              const description = repo.description || 'Backend development project';
              content += `${description}\n\n`;
              
              // Tech stack
              content += `**Tech Stack:** ${techStack}`;
              
              // Add forks if any
              if (repo.forks_count > 0) {
                content += ` â€¢ **Forks:** ${repo.forks_count}`;
              }
              
              content += `  \n`;
              
              // Last update
              content += `**Last updated:** ${formattedDate}`;
              
              // Last commit message
              if (lastCommitMsg) {
                content += `  \nğŸ’¬ _"${lastCommitMsg}"_`;
              }
              
              content += `\n\n---\n\n`;
            }
            
            console.log('\nğŸ“– Reading current README...');
            
            // Read current README
            const { data: readmeData } = await github.rest.repos.getContent({
              owner,
              repo: 'EversonRubira',
              path: 'README.md'
            });
            
            const readme = Buffer.from(readmeData.content, 'base64').toString('utf-8');
            
            // Replace content between markers
            const startMarker = '<!-- RECENT_PROJECTS:START -->';
            const endMarker = '<!-- RECENT_PROJECTS:END -->';
            
            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`, 'g');
            
            if (!regex.test(readme)) {
              console.error('âŒ Markers not found in README!');
              core.setFailed('Markers <!-- RECENT_PROJECTS:START --> and <!-- RECENT_PROJECTS:END --> not found');
              return;
            }
            
            const newReadme = readme.replace(
              regex,
              `${startMarker}\n${content}${endMarker}`
            );
            
            // Check if there were changes
            if (readme === newReadme) {
              console.log('âœ¨ No changes detected. README is already up to date!');
              return;
            }
            
            console.log('ğŸ’¾ Updating README...');
            
            // Update README
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo: 'EversonRubira',
              path: 'README.md',
              message: 'ğŸ¤– Auto-update: Recent projects updated',
              content: Buffer.from(newReadme).toString('base64'),
              sha: readmeData.sha
            });
            
            console.log('âœ… README updated successfully!');
