name: Update README with Recent Projects

on:
  schedule:
    # Runs daily at 00:00 UTC (01:00 Portugal time)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual execution
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update README with recent projects
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'EversonRubira';

            // Map GitHub topics to display names for frameworks/databases/tools
            const TOPIC_DISPLAY_NAMES = {
              'spring-boot':    'Spring Boot',
              'spring':         'Spring Boot',
              'spring-security':'Spring Security',
              'mysql':          'MySQL',
              'mongodb':        'MongoDB',
              'postgresql':     'PostgreSQL',
              'redis':          'Redis',
              'docker':         'Docker',
              'nodejs':         'Node.js',
              'node':           'Node.js',
              'express':        'Express',
              'react':          'React',
              'angular':        'Angular',
              'vue':            'Vue.js',
              'fastapi':        'FastAPI',
              'django':         'Django',
              'flask':          'Flask',
              'hibernate':      'Hibernate',
              'jpa':            'JPA',
              'kafka':          'Kafka',
              'rabbitmq':       'RabbitMQ',
              'aws':            'AWS',
              'kubernetes':     'Kubernetes',
            };

            // Languages considered "backend/primary" â€” HTML/CSS are excluded when these are present
            const BACKEND_LANGUAGES = new Set([
              'Java', 'Python', 'Go', 'Rust', 'C', 'C++', 'C#',
              'TypeScript', 'JavaScript', 'Kotlin', 'Scala', 'Ruby', 'PHP'
            ]);

            // Languages to hide when a backend language is detected
            const MARKUP_LANGUAGES = new Set(['HTML', 'CSS', 'SCSS', 'Less']);

            console.log('ğŸ” Fetching repositories...');

            // Fetch all public repositories sorted by last push
            const { data: repos } = await github.rest.repos.listForUser({
              username: owner,
              sort: 'pushed',
              direction: 'desc',
              per_page: 100
            });

            console.log(`ğŸ“¦ Total repositories found: ${repos.length}`);

            // Filter own repositories (not forks) and exclude profile repo
            const recentRepos = repos
              .filter(repo => !repo.fork && repo.name !== 'EversonRubira')
              .slice(0, 4);

            console.log('âœ… Selected repositories:');
            recentRepos.forEach(repo => console.log(`   - ${repo.name}`));

            // Generate markdown for each repository
            let content = '';

            for (const repo of recentRepos) {
              console.log(`\nğŸ“ Processing: ${repo.name}`);

              // Fetch full repo details (includes topics)
              const { data: repoDetails } = await github.rest.repos.get({
                owner,
                repo: repo.name
              });
              const topics = repoDetails.topics || [];
              console.log(`   Topics: ${topics.join(', ') || '(none)'}`);

              // Fetch repository languages (returns { Language: bytes })
              const { data: languages } = await github.rest.repos.listLanguages({
                owner,
                repo: repo.name
              });

              // Determine if any backend language is present
              const detectedLangs = Object.keys(languages);
              const hasBackend = detectedLangs.some(l => BACKEND_LANGUAGES.has(l));

              // Filter out markup languages if a backend language exists
              const filteredLangs = hasBackend
                ? detectedLangs.filter(l => !MARKUP_LANGUAGES.has(l)).slice(0, 2)
                : detectedLangs.slice(0, 2);

              // Build framework/db list from topics
              const topicStack = topics
                .filter(t => TOPIC_DISPLAY_NAMES[t])
                .map(t => TOPIC_DISPLAY_NAMES[t]);

              // Combine: languages first, then frameworks/databases from topics
              const combined = [...filteredLangs, ...topicStack];
              // Deduplicate while preserving order
              const techStack = [...new Set(combined)].join(', ') || repo.language || 'N/A';
              console.log(`   Tech Stack: ${techStack}`);

              // Format last push date in English
              const lastPushDate = new Date(repo.pushed_at);
              const formattedDate = lastPushDate.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              });

              // Fetch last commit message
              let lastCommitMsg = '';
              try {
                const { data: commits } = await github.rest.repos.listCommits({
                  owner,
                  repo: repo.name,
                  per_page: 1
                });
                if (commits.length > 0) {
                  lastCommitMsg = commits[0].commit.message.split('\n')[0];
                  if (lastCommitMsg.length > 60) {
                    lastCommitMsg = lastCommitMsg.substring(0, 57) + '...';
                  }
                }
              } catch (error) {
                console.log(`   âš ï¸ Could not fetch commits: ${error.message}`);
              }

              // Build markdown block
              content += `### ğŸ”¹ [${repo.name}](${repo.html_url})`;
              if (repo.stargazers_count > 0) {
                content += ` â­ ${repo.stargazers_count}`;
              }
              content += `\n`;

              const description = repo.description || 'Backend development project';
              content += `${description}\n\n`;

              content += `**Tech Stack:** ${techStack}`;
              if (repo.forks_count > 0) {
                content += ` â€¢ **Forks:** ${repo.forks_count}`;
              }
              content += `  \n`;

              content += `**Last updated:** ${formattedDate}`;
              if (lastCommitMsg) {
                content += `  \nğŸ’¬ _"${lastCommitMsg}"_`;
              }

              content += `\n\n---\n\n`;
            }

            console.log('\nğŸ“– Reading current README...');

            // Read current README
            const { data: readmeData } = await github.rest.repos.getContent({
              owner,
              repo: 'EversonRubira',
              path: 'README.md'
            });

            const readme = Buffer.from(readmeData.content, 'base64').toString('utf-8');

            // Replace content between markers
            const startMarker = '<!-- RECENT_PROJECTS:START -->';
            const endMarker = '<!-- RECENT_PROJECTS:END -->';
            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`, 'g');

            if (!regex.test(readme)) {
              console.error('âŒ Markers not found in README!');
              core.setFailed('Markers <!-- RECENT_PROJECTS:START --> and <!-- RECENT_PROJECTS:END --> not found');
              return;
            }

            const newReadme = readme.replace(
              regex,
              `${startMarker}\n${content}${endMarker}`
            );

            if (readme === newReadme) {
              console.log('âœ¨ No changes detected. README is already up to date!');
              return;
            }

            console.log('ğŸ’¾ Updating README...');

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo: 'EversonRubira',
              path: 'README.md',
              message: 'ğŸ¤– Auto-update: Recent projects updated',
              content: Buffer.from(newReadme).toString('base64'),
              sha: readmeData.sha
            });

            console.log('âœ… README updated successfully!');
